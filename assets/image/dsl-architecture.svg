<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 600">
  <defs>
    <marker id="arrow" markerWidth="6" markerHeight="5" refX="5" refY="2.5" orient="auto">
      <polygon points="0 0, 6 2.5, 0 5" fill="#666"/>
    </marker>
    <marker id="arrow-blue" markerWidth="6" markerHeight="5" refX="5" refY="2.5" orient="auto">
      <polygon points="0 0, 6 2.5, 0 5" fill="#1976d2"/>
    </marker>
    <marker id="arrow-green" markerWidth="6" markerHeight="5" refX="5" refY="2.5" orient="auto">
      <polygon points="0 0, 6 2.5, 0 5" fill="#388e3c"/>
    </marker>
    <marker id="arrow-pink" markerWidth="6" markerHeight="5" refX="5" refY="2.5" orient="auto">
      <polygon points="0 0, 6 2.5, 0 5" fill="#c2185b"/>
    </marker>
    <marker id="arrow-orange" markerWidth="6" markerHeight="5" refX="5" refY="2.5" orient="auto">
      <polygon points="0 0, 6 2.5, 0 5" fill="#f57c00"/>
    </marker>
    <marker id="arrow-cyan" markerWidth="6" markerHeight="5" refX="5" refY="2.5" orient="auto">
      <polygon points="0 0, 6 2.5, 0 5" fill="#0097a7"/>
    </marker>
  </defs>

  <!-- Title -->
  <text x="450" y="25" text-anchor="middle" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="#333">AlphaLab API Architecture</text>

  <!-- Legend (transparent background, with border) -->
  <rect x="720" y="40" width="160" height="90" rx="5" fill="none" stroke="#ddd" stroke-width="1"/>
  <rect x="730" y="50" width="12" height="12" fill="#e3f2fd" stroke="#1976d2"/>
  <text x="748" y="60" font-family="Arial, sans-serif" font-size="10" fill="#333">Public API</text>
  <rect x="730" y="68" width="12" height="12" fill="#e8f5e9" stroke="#388e3c"/>
  <text x="748" y="78" font-family="Arial, sans-serif" font-size="10" fill="#333">Internal Module</text>
  <rect x="730" y="86" width="12" height="12" fill="#fff3e0" stroke="#f57c00"/>
  <text x="748" y="96" font-family="Arial, sans-serif" font-size="10" fill="#333">Data Layer</text>
  <rect x="730" y="104" width="12" height="12" fill="#fce4ec" stroke="#c2185b"/>
  <text x="748" y="114" font-family="Arial, sans-serif" font-size="10" fill="#333">Core Classes</text>

  <!-- USER CODE -->
  <rect x="380" y="45" width="140" height="35" rx="5" fill="#f5f5f5" stroke="#9e9e9e" stroke-width="2"/>
  <text x="450" y="68" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#424242">User Code</text>

  <!-- PUBLIC API LAYER -->
  <rect x="20" y="100" width="680" height="130" rx="8" fill="none" stroke="#1976d2" stroke-width="2" stroke-dasharray="5,3"/>
  <text x="35" y="118" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#1976d2">Public API (alphalab.api)</text>

  <!-- AlphaLabClient box -->
  <rect x="40" y="130" width="320" height="90" rx="5" fill="#e3f2fd" stroke="#1976d2" stroke-width="2"/>
  <text x="200" y="150" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#1565c0">AlphaLabClient</text>

  <!-- Client methods -->
  <rect x="55" y="160" width="70" height="25" rx="3" fill="#bbdefb" stroke="#1976d2"/>
  <text x="90" y="177" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#0d47a1">lookup()</text>

  <rect x="135" y="160" width="55" height="25" rx="3" fill="#bbdefb" stroke="#1976d2"/>
  <text x="162" y="177" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#0d47a1">get()</text>

  <rect x="200" y="160" width="65" height="25" rx="3" fill="#bbdefb" stroke="#1976d2"/>
  <text x="232" y="177" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#0d47a1">query()</text>

  <rect x="275" y="160" width="70" height="25" rx="3" fill="#bbdefb" stroke="#1976d2"/>
  <text x="310" y="177" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#0d47a1">universe()</text>

  <!-- dsl.compute box -->
  <rect x="400" y="145" width="140" height="55" rx="5" fill="#e3f2fd" stroke="#1976d2" stroke-width="2"/>
  <text x="470" y="165" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="#1565c0">dsl</text>
  <rect x="415" y="172" width="110" height="22" rx="3" fill="#bbdefb" stroke="#1976d2"/>
  <text x="470" y="188" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#0d47a1">compute()</text>

  <!-- operators box -->
  <rect x="560" y="145" width="120" height="55" rx="5" fill="#e3f2fd" stroke="#1976d2" stroke-width="2"/>
  <text x="620" y="165" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="#1565c0">operators</text>
  <text x="620" y="182" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#1976d2">68 functions</text>
  <text x="620" y="194" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#666">rank, ts_delta, ...</text>

  <!-- Curved arrows from User Code -->
  <path d="M 420 80 Q 300 90 280 128" stroke="#666" stroke-width="1.5" fill="none" marker-end="url(#arrow)"/>
  <path d="M 480 80 Q 500 120 470 143" stroke="#666" stroke-width="1.5" fill="none" marker-end="url(#arrow)"/>

  <!-- Arrow from query to dsl.compute -->
  <path d="M 265 172 Q 330 160 398 172" stroke="#1976d2" stroke-width="1.5" fill="none" marker-end="url(#arrow-blue)"/>

  <!-- Arrow from dsl to operators -->
  <path d="M 540 172 Q 550 172 558 172" stroke="#1976d2" stroke-width="1.5" fill="none" marker-end="url(#arrow-blue)"/>

  <!-- INTERNAL LAYER -->
  <rect x="20" y="245" width="680" height="100" rx="8" fill="none" stroke="#388e3c" stroke-width="2" stroke-dasharray="5,3"/>
  <text x="35" y="263" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#388e3c">Internal (alphalab.alpha, alphalab.api.data)</text>

  <!-- SecurityMaster -->
  <rect x="40" y="275" width="120" height="55" rx="5" fill="#e8f5e9" stroke="#388e3c" stroke-width="2"/>
  <text x="100" y="295" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#2e7d32">SecurityMaster</text>
  <text x="100" y="310" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#558b2f">symbol â†’ security_id</text>
  <text x="100" y="322" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#558b2f">ticker changes</text>

  <!-- CalendarMaster -->
  <rect x="175" y="275" width="110" height="55" rx="5" fill="#e8f5e9" stroke="#388e3c" stroke-width="2"/>
  <text x="230" y="295" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#2e7d32">CalendarMaster</text>
  <text x="230" y="310" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#558b2f">trading days</text>
  <text x="230" y="322" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#558b2f">date alignment</text>

  <!-- StorageBackend -->
  <rect x="300" y="275" width="110" height="55" rx="5" fill="#e8f5e9" stroke="#388e3c" stroke-width="2"/>
  <text x="355" y="295" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#2e7d32">StorageBackend</text>
  <text x="355" y="310" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#558b2f">read parquet/arrow</text>
  <text x="355" y="322" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#558b2f">local filesystem</text>

  <!-- _evaluate -->
  <rect x="430" y="275" width="130" height="55" rx="5" fill="#e8f5e9" stroke="#388e3c" stroke-width="2"/>
  <text x="495" y="295" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#2e7d32">parser._evaluate</text>
  <text x="495" y="310" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#558b2f">AST parsing</text>
  <text x="495" y="322" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#558b2f">eval/exec mode</text>

  <!-- SafeEvaluator -->
  <rect x="575" y="275" width="110" height="55" rx="5" fill="#e8f5e9" stroke="#388e3c" stroke-width="2"/>
  <text x="630" y="295" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#2e7d32">SafeEvaluator</text>
  <text x="630" y="310" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#558b2f">AST visitor</text>
  <text x="630" y="322" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#558b2f">secure execution</text>

  <!-- Curved arrows from client methods to internal -->
  <path d="M 90 185 Q 70 230 90 273" stroke="#388e3c" stroke-width="1.5" fill="none" marker-end="url(#arrow-green)"/>
  <path d="M 162 185 Q 280 220 340 273" stroke="#388e3c" stroke-width="1.5" fill="none" marker-end="url(#arrow-green)"/>
  <path d="M 232 185 Q 200 210 200 243" stroke="#388e3c" stroke-width="1.5" fill="none" stroke-dasharray="3,2"/>
  <text x="180" y="218" font-family="Arial, sans-serif" font-size="9" fill="#388e3c">uses get()</text>

  <!-- Curved arrow from dsl.compute to _evaluate -->
  <path d="M 470 200 Q 450 240 485 273" stroke="#388e3c" stroke-width="1.5" fill="none" marker-end="url(#arrow-green)"/>

  <!-- Arrow from _evaluate to SafeEvaluator -->
  <path d="M 560 302 Q 567 302 573 302" stroke="#388e3c" stroke-width="1.5" fill="none" marker-end="url(#arrow-green)"/>

  <!-- CORE CLASSES -->
  <rect x="720" y="245" width="160" height="100" rx="8" fill="none" stroke="#c2185b" stroke-width="2" stroke-dasharray="5,3"/>
  <text x="800" y="263" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#c2185b">Core Classes</text>

  <!-- Alpha class -->
  <rect x="735" y="275" width="130" height="55" rx="5" fill="#fce4ec" stroke="#c2185b" stroke-width="2"/>
  <text x="800" y="295" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#ad1457">Alpha</text>
  <text x="800" y="310" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#880e4f">DataFrame wrapper</text>
  <text x="800" y="322" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#880e4f">operator overloading</text>

  <!-- Arrow from SafeEvaluator to Alpha -->
  <path d="M 685 302 Q 710 302 733 302" stroke="#c2185b" stroke-width="1.5" fill="none" marker-end="url(#arrow-pink)"/>

  <!-- DATA LAYER -->
  <rect x="20" y="360" width="860" height="130" rx="8" fill="none" stroke="#f57c00" stroke-width="2" stroke-dasharray="5,3"/>
  <text x="35" y="378" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#f57c00">Data Layer ($LOCAL_STORAGE_PATH)</text>

  <!-- security_master.parquet -->
  <rect x="40" y="395" width="150" height="80" rx="5" fill="#fff3e0" stroke="#f57c00" stroke-width="2"/>
  <text x="115" y="415" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#e65100">meta/master/</text>
  <text x="115" y="432" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#f57c00">security_master.parquet</text>
  <text x="115" y="445" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#f57c00">calendar_master.parquet</text>
  <text x="115" y="458" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#f57c00">prev_universe.json</text>

  <!-- universe -->
  <rect x="210" y="395" width="140" height="80" rx="5" fill="#fff3e0" stroke="#f57c00" stroke-width="2"/>
  <text x="280" y="415" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#e65100">meta/universe/</text>
  <text x="280" y="435" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#f57c00">{YYYY}/{MM}/</text>
  <text x="280" y="450" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#f57c00">top3000.txt</text>

  <!-- features -->
  <rect x="370" y="395" width="150" height="80" rx="5" fill="#fff3e0" stroke="#f57c00" stroke-width="2"/>
  <text x="445" y="415" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#e65100">features/</text>
  <text x="445" y="435" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#f57c00">close.arrow</text>
  <text x="445" y="450" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#f57c00">volume.arrow</text>
  <text x="445" y="465" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#f57c00">... (66 fields)</text>

  <!-- raw ticks -->
  <rect x="540" y="395" width="155" height="80" rx="5" fill="#fff3e0" stroke="#f57c00" stroke-width="2"/>
  <text x="617" y="415" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#e65100">raw/ticks/</text>
  <text x="617" y="435" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#f57c00">{security_id}/</text>
  <text x="617" y="450" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#f57c00">ticks.parquet</text>

  <!-- raw fundamental -->
  <rect x="715" y="395" width="155" height="80" rx="5" fill="#fff3e0" stroke="#f57c00" stroke-width="2"/>
  <text x="792" y="415" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#e65100">raw/fundamental/</text>
  <text x="792" y="435" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#f57c00">{security_id}/</text>
  <text x="792" y="450" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#f57c00">fundamental.parquet</text>

  <!-- Curved arrows from internal to data -->
  <path d="M 100 330 Q 80 365 115 393" stroke="#f57c00" stroke-width="1.5" fill="none" marker-end="url(#arrow-orange)"/>
  <path d="M 230 330 Q 210 365 260 393" stroke="#f57c00" stroke-width="1.5" fill="none" marker-end="url(#arrow-orange)"/>
  <path d="M 355 330 Q 340 365 420 393" stroke="#f57c00" stroke-width="1.5" fill="none" marker-end="url(#arrow-orange)"/>

  <!-- Output annotation -->
  <rect x="720" y="510" width="160" height="70" rx="5" fill="#e0f7fa" stroke="#0097a7" stroke-width="2"/>
  <text x="800" y="530" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#00838f">Output</text>
  <text x="800" y="548" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#006064">pl.DataFrame</text>
  <text x="800" y="563" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#006064">Wide format:</text>
  <text x="800" y="575" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#006064">Date + symbol columns</text>

  <!-- Curved arrow from Alpha to Output -->
  <path d="M 800 330 Q 860 420 800 508" stroke="#0097a7" stroke-width="1.5" fill="none" marker-end="url(#arrow-cyan)"/>
</svg>
